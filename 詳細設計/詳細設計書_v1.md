# 株式会社〇〇 オンライン販売サイト  詳細設計書

| ドキュメントバージョン | 1.0                                   |
| :------------------- | :------------------------------------ |
| 作成日               | 2025年7月7日                        |
| 作成チーム           | チームBacon                            |
| 更新履歴             | 2025/07/07: Ver.1.0 初版作成 (チームbacon) |

## 1. はじめに

### 1.1. 本書の目的

本書は、株式会社〇〇が展開する雑貨ブランドのECサイト構築プロジェクトにおける詳細設計の内容を定義するものです。株式会社〇〇オンライン販売サイト 基本設計書 Ver.1.0で定義された内容に基づき、実装担当者がプログラミング作業を迷いなく進められるように、システムの内部構造、処理フロー、インターフェース、データベース構造、画面項目などを具体的に記述します。

### 1.2. 前提となる基本設計書

本書は、以下の基本設計書の内容を前提としています。

-  株式会社〇〇 オンライン販売サイト 基本設計書 Ver.1.0

### 1.3. 対象読者

本書は、以下の担当者を対象としています。

- 本システムのバックエンド開発担当者
- 本システムのフロントエンド開発担当者
- 本システムのテスト担当者
- プロジェクト管理者

### 1.4. 参考文献

- 株式会社〇〇 オンライン販売サイト 基本設計書 Ver.1.0
- (チーム内で使用するコーディング規約などがあれば記載)

## 2.システム概要
対象ユーザーに関しては基本設計書「Version1.0」の「2 システム概要」に記載の通りです。


###　2.1システム概要図

<div class="mermaid">
graph LR
    subgraph ユーザー環境
        A[クライアント<br>（PC/スマホ/ブラウザ）<br>HTML/CSS/JavaScript]
    end


    subgraph クラウド環境
        subgraph Webサーバー
            B[Nginx]
        end


        subgraph APIサーバー Spring Boot
            S[セッション・認証管理<br>（Spring Security<br>+ JVMセッション管理）]
            C[Controller<br>（Spring MVC）]
            D[Service<br>（ビジネスロジック）]
            E[Repository<br>（JPA/Hibernate）]
        end


        subgraph DBサーバー
            F[H2/PostgreSQL 15]
        end


        subgraph オブジェクトストレージ
            G[MinIO （S3互換）]
        end


        subgraph 外部API
            H[Amazon SES<br>（メール送信）]
        end
    end


    %% ログイン処理フロー
    A -- ① ログインリクエスト<br>(ID/パスワードPOST) --> B
    B -- ② API転送 --> S
    S -- ③ 認証チェック --> D
    D -- ④ ユーザ情報照合 --> E
    E -- ⑤ 照合結果 --> D
    D -- ⑥ 認証結果 --> S
    S -- ⑦ セッショントークン発行<br>(Set-Cookie/JWT) --> A


    %% 認証付きAPIアクセス
    A -- ⑧ APIリクエスト<br>(Cookie/JWT付与) --> B
    B -- ⑨ API転送 --> S
    S -- ⑩ セッション/トークン検証 --> C
    C -- ⑪ 処理依頼 --> D
    D -- ⑫ データアクセス --> E
    E -- ⑬ SQL実行 --> F
    F -- ⑭ データ --> E
    E -- ⑮ 結果 --> D
    D -- ⑯ 結果 --> C
    C -- ⑰ APIレスポンス<br>(JSON) --> B
    B -- ⑱ HTTPSレスポンス --> A


    %% さらにストレージや外部API呼び出し
    D -- ファイル保存/取得 --> G
    D -- メール送信API --> H


    %% スタイル
    style A fill:#f9f,stroke:#333,stroke-width:1.5px
    style B fill:#ffcc99,stroke:#333,stroke-width:1.5px
    style C fill:#ccffcc,stroke:#333,stroke-width:1.5px
    style D fill:#99ccff,stroke:#333,stroke-width:1.5px
    style E fill:#6699cc,stroke:#333,stroke-width:1.5px
    style F fill:#99ff99,stroke:#333,stroke-width:1.5px
    style G fill:#cccccc,stroke:#333,stroke-width:1.5px
    style H fill:#ff9999,stroke:#333,stroke-width:1.5px
    style S fill:#ffff99,stroke:#333,stroke-width:1.5px
</div>
# 3. 機能仕様
## 3.1. 機能一覧

本システムが提供する必須機能は以下の通りです。

| 機能ID | 機能名                   |
|--------|--------------------------|
| F0101  | トップページ表示          |
| F0201  | 商品一覧表示              |
| F0202  | 商品詳細表示              |
| F0301  | カート操作                |
| F0401  | 注文情報入力              |
| F0402  | 注文確認                  |
| F0403  | 注文完了                  |
| F0501  | 会員登録                  |
| F0502  | 会員情報変更              |
| F0601  | ログイン                  |
| F0602  | ログアウト                |
| F0603  | マイページ表示            |
| F0604  | 注文履歴表示              |
| F0605  | 購入前ログイン            |
| F0701  | 特定商取引法表示          |
| F0801  | プライバシーポリシー表示  |
| F0901  | FAQ表示                   |
| F1001  | 共通エラーページ表示      |
| F1101  | 自動入力                  |
| F1201  | 注文確定メール通知（銀行口座） |

---

## 3.2. 機能詳細

### 3.2.1. 購入フローシーケンス図

<div class="mermaid">
sequenceDiagram
    %% 4.5.1: 購入フローシーケンス図（修正版）
    participant User as ユーザー (Browser)
    participant FE as フロントエンド (JS)
    participant CartController
    participant CartService
    participant ProductRepository
    participant OrderController
    participant OrderService
    participant OrderRepository
    participant OrderDetailRepository
    participant MailService
    participant Session as セッション管理
    participant DB as データベース

    %% カートに商品追加
    User->>FE: 商品をカートに追加
    FE->>CartController: POST /api/cart/add
    CartController->>CartService: addItem(productId, qty, session)
    CartService->>ProductRepository: findById(productId)
    ProductRepository->>DB: SELECT * FROM products WHERE id=?
    DB-->>ProductRepository: Product
    ProductRepository-->>CartService: Product
    CartService-->>CartController: Updated Cart
    CartController-->>FE: JSON (Updated Cart)
    FE-->>User: カートを表示

    %% 購入手続き開始
    User->>FE: 購入手続き
    FE->>OrderController: POST /api/orders

    %% セッションから顧客ID取得
    OrderController->>Session: セッションから顧客ID取得
    Session-->>OrderController: customerId

    %% カート情報をサーバー側で取得（明示）
    OrderController->>CartService: getCart(customerId)
    CartService-->>OrderController: Cart

    %% 注文処理開始
    OrderController->>OrderService: placeOrder(cart, orderRequest, customerId)

    %% 注文エンティティ生成
    OrderService->>OrderService: Orderを生成（cart, orderRequest, customerId）

    %% 注文保存
    OrderService->>OrderRepository: save(Order)
    OrderRepository->>DB: INSERT INTO orders ...
    DB-->>OrderRepository: Order ID
    OrderRepository-->>OrderService: Order ID

    %% 注文詳細生成・設定
    OrderService->>OrderService: OrderDetails = createOrderDetailsFromCart(cart)
    OrderService->>OrderService: Order IDをOrderDetailsに設定

    %% 注文詳細保存
    OrderService->>OrderDetailRepository: saveAll(OrderDetails)
    OrderDetailRepository->>DB: INSERT INTO order_details ...
    DB-->>OrderDetailRepository: Insert Success
    OrderDetailRepository-->>OrderService: Insert Result

    %% 注文確認メール送信
    OrderService->>MailService: sendOrderConfirmationEmail(order)
    MailService->>User: 注文確認メール送信（注文番号、合計金額、配送予定日などを含む）
    MailService-->>OrderService: メール送信完了

    %% OrderResponse生成（注文番号、合計金額、配送予定日など含む）
    OrderService->>OrderService: OrderResponseを生成(orderNo, totalPrice, deliveryDate, ...)

    %% 応答返却
    OrderService-->>OrderController: OrderResponse
    OrderController-->>FE: JSON (OrderResponse)
    FE-->>User: 購入確定画面を表示
</div>

### 3.2.2. ログイン・ログアウトシーケンス図 (セッション管理)

<div class="mermaid">
sequenceDiagram
    %% No.1: 購入フロー一式
    participant User as ユーザー (Browser)
    participant FE as フロントエンド (JS)
    participant CartController
    participant CartService
    participant ProductRepository
    participant OrderController
    participant OrderService
    participant OrderRepository
    participant OrderDetailRepository
    participant MailService
    participant DB as データベース

    User->>FE: 商品をカートに追加
    FE->>CartController: POST /api/cart/add
    CartController->>CartService: addItem(productId, qty, session)
    CartService->>ProductRepository: findById(productId)
    ProductRepository->>DB: SELECT * FROM products WHERE id=?
    DB-->>ProductRepository: Product
    ProductRepository-->>CartService: Product
    CartService-->>CartController: Updated Cart
    CartController-->>FE: JSON (Updated Cart)
    FE-->>User: カートを表示

    User->>FE: 購入手続き
    FE->>OrderController: POST /api/orders
    OrderController->>OrderService: placeOrder(cart, orderRequest)
    OrderService->>OrderRepository: save(Order)
    OrderRepository->>DB: INSERT INTO orders ...
    DB-->>OrderRepository: Order ID
    OrderService->>OrderDetailRepository: saveAll(OrderDetails)
    OrderDetailRepository->>DB: INSERT INTO order_details ...
    DB-->>OrderDetailRepository: Success
    OrderService->>MailService: sendOrderConfirmationEmail()
    MailService->>User: 確認メール送信
    OrderService-->>OrderController: OrderResponse
    OrderController-->>FE: JSON (OrderResponse)
    FE-->>User: 購入確定画面を表示


    %% No.2: 会員登録、ログイン・ログアウト機能
    participant User as ユーザー (Browser)
    participant FE as フロントエンド (JS)
    participant CustomerController
    participant CustomerService
    participant CustomerRepository
    participant Session as セッション管理
    participant DB as データベース

    User->>FE: 会員登録フォーム入力
    FE->>CustomerController: POST /api/customers/register
    CustomerController->>CustomerService: registerCustomer(request)
    CustomerService->>CustomerRepository: save(Customer)
    CustomerRepository->>DB: INSERT INTO customers ...
    DB-->>CustomerRepository: 保存成功
    CustomerService-->>CustomerController: CustomerResponse
    CustomerController-->>FE: JSON (CustomerResponse)
    FE-->>User: 会員登録完了画面を表示

    User->>FE: ログイン情報入力
    FE->>CustomerController: POST /api/customers/login
    CustomerController->>CustomerService: authenticate(request)
    CustomerService->>CustomerRepository: findByEmail()
    CustomerRepository->>DB: SELECT * FROM customers WHERE email=?
    DB-->>CustomerRepository: Customer
    CustomerRepository-->>CustomerService: Customer
    CustomerService->>Session: セッションへ会員情報保存
    CustomerService-->>CustomerController: CustomerResponse
    CustomerController-->>FE: JSON (CustomerResponse)
    FE-->>User: マイページ表示

    User->>FE: ログアウト操作
    FE->>CustomerController: POST /api/customers/logout
    CustomerController->>Session: セッション破棄
    Session-->>CustomerController: OK
    CustomerController-->>FE: OK
    FE-->>User: ログイン画面を表示
</div>

### 3.2.3. マイページ・注文履歴・会員情報変更シーケンス図 

<div class="mermaid">
sequenceDiagram
    %% No.1: 購入フロー一式
    participant User as ユーザー (Browser)
    participant FE as フロントエンド (JS)
    participant CartController
    participant CartService
    participant ProductRepository
    participant OrderController
    participant OrderService
    participant OrderRepository
    participant OrderDetailRepository
    participant MailService
    participant DB as データベース

    User->>FE: 商品をカートに追加
    FE->>CartController: POST /api/cart/add
    CartController->>CartService: addItem(productId, qty, session)
    CartService->>ProductRepository: findById(productId)
    ProductRepository->>DB: SELECT * FROM products WHERE id=?
    DB-->>ProductRepository: Product
    ProductRepository-->>CartService: Product
    CartService-->>CartController: Updated Cart
    CartController-->>FE: JSON (Updated Cart)
    FE-->>User: カートを表示

    User->>FE: 購入手続き
    FE->>OrderController: POST /api/orders
    OrderController->>OrderService: placeOrder(cart, orderRequest)
    OrderService->>OrderRepository: save(Order)
    OrderRepository->>DB: INSERT INTO orders ...
    DB-->>OrderRepository: Order ID
    OrderService->>OrderDetailRepository: saveAll(OrderDetails)
    OrderDetailRepository->>DB: INSERT INTO order_details ...
    DB-->>OrderDetailRepository: Success
    OrderService->>MailService: sendOrderConfirmationEmail()
    MailService->>User: 確認メール送信
    OrderService-->>OrderController: OrderResponse
    OrderController-->>FE: JSON (OrderResponse)
    FE-->>User: 購入確定画面を表示


    %% No.2: 会員登録、ログイン・ログアウト機能
    participant User as ユーザー (Browser)
    participant FE as フロントエンド (JS)
    participant CustomerController
    participant CustomerService
    participant CustomerRepository
    participant Session as セッション管理
    participant DB as データベース

    User->>FE: 会員登録フォーム入力
    FE->>CustomerController: POST /api/customers/register
    CustomerController->>CustomerService: registerCustomer(request)
    CustomerService->>CustomerRepository: save(Customer)
    CustomerRepository->>DB: INSERT INTO customers ...
    DB-->>CustomerRepository: 保存成功
    CustomerService-->>CustomerController: CustomerResponse
    CustomerController-->>FE: JSON (CustomerResponse)
    FE-->>User: 会員登録完了画面を表示

    User->>FE: ログイン情報入力
    FE->>CustomerController: POST /api/customers/login
    CustomerController->>CustomerService: authenticate(request)
    CustomerService->>CustomerRepository: findByEmail()
    CustomerRepository->>DB: SELECT * FROM customers WHERE email=?
    DB-->>CustomerRepository: Customer
    CustomerRepository-->>CustomerService: Customer
    CustomerService->>Session: セッションへ会員情報保存
    CustomerService-->>CustomerController: CustomerResponse
    CustomerController-->>FE: JSON (CustomerResponse)
    FE-->>User: マイページ表示

    User->>FE: ログアウト操作
    FE->>CustomerController: POST /api/customers/logout
    CustomerController->>Session: セッション破棄
    Session-->>CustomerController: OK
    CustomerController-->>FE: OK
    FE-->>User: ログイン画面を表示


    %% No.3: マイページ・注文履歴・会員情報変更
    participant User as ユーザー (Browser)
    participant FE as フロントエンド (JS)
    participant CustomerController
    participant CustomerService
    participant OrderRepository
    participant CustomerRepository
    participant Session as セッション管理
    participant DB as データベース

    User->>FE: マイページアクセス
    FE->>CustomerController: GET /api/customers/mypage
    CustomerController->>Session: 顧客IDを取得
    Session-->>CustomerController: customerId
    CustomerController->>CustomerService: getCustomerProfile(customerId)
    CustomerService->>CustomerRepository: findById(customerId)
    CustomerRepository->>DB: SELECT * FROM customers WHERE id=?
    DB-->>CustomerRepository: Customer
    CustomerRepository-->>CustomerService: Customer
    CustomerService-->>CustomerController: CustomerResponse
    CustomerController-->>FE: JSON (CustomerResponse)
    FE-->>User: プロフィール表示

    User->>FE: 注文履歴の表示
    FE->>CustomerController: GET /api/customers/orders
    CustomerController->>Session: 顧客IDを取得
    Session-->>CustomerController: customerId
    CustomerController->>CustomerService: getOrderHistory(customerId)
    CustomerService->>OrderRepository: findByCustomerId(customerId)
    OrderRepository->>DB: SELECT * FROM orders WHERE customer_id=?
    DB-->>OrderRepository: List<Order>
    OrderRepository-->>CustomerService: List<Order>
    CustomerService-->>CustomerController: List<OrderSummary>
    CustomerController-->>FE: JSON (OrderSummary List)
    FE-->>User: 注文履歴を表示

    User->>FE: 会員情報の変更を入力
    FE->>CustomerController: PUT /api/customers/update
    CustomerController->>Session: 顧客IDを取得
    Session-->>CustomerController: customerId
    CustomerController->>CustomerService: updateCustomerInfo(request)
    CustomerService->>CustomerRepository: save(updatedCustomer)
    CustomerRepository->>DB: UPDATE customers SET ...
    DB-->>CustomerRepository: 更新成功
    CustomerRepository-->>CustomerService: 更新後Customer
    CustomerService-->>CustomerController: CustomerResponse
    CustomerController-->>FE: JSON (CustomerResponse)
    FE-->>User: 更新完了メッセージ表示
</div>

### 3.2.4.  カート操作・購入前ログインシーケンス図

<div class="mermaid">
sequenceDiagram
    %% No.4: カート操作・購入前ログイン
    participant User as ユーザー (Browser)
    participant FE as フロントエンド (JS)
    participant CartController
    participant CartService
    participant ProductRepository
    participant Session as セッション管理
    participant DB as データベース
    participant CustomerController
    participant CustomerService
    participant CustomerRepository

    User->>FE: 商品をカートに追加
    FE->>CartController: POST /api/cart/add
    CartController->>CartService: addItemToCart(productId, quantity, session)
    CartService->>ProductRepository: findById(productId)
    ProductRepository->>DB: SELECT * FROM products WHERE id=?
    DB-->>ProductRepository: Product
    ProductRepository-->>CartService: Product
    CartService-->>CartController: Updated Cart
    CartController-->>FE: JSON (Cart)
    FE-->>User: カートを表示

    User->>FE: ログイン操作
    FE->>CustomerController: POST /api/customers/login
    CustomerController->>CustomerService: authenticate(request)
    CustomerService->>CustomerRepository: findByEmail()
    CustomerRepository->>DB: SELECT * FROM customers WHERE email=?
    DB-->>CustomerRepository: Customer
    CustomerRepository-->>CustomerService: Customer
    CustomerService->>Session: セッションへ会員情報保存
    CustomerService-->>CustomerController: CustomerResponse
    CustomerController-->>FE: JSON (CustomerResponse)
    FE-->>User: ログイン完了後にカート画面を再表示
</div>

### 3.2.5.  カート操作・購入前ログインシーケンス図 

<div class="mermaid">
%% No.5: 商品一覧・詳細表示
sequenceDiagram
    participant User as ユーザー (Browser)
    participant FE as フロントエンド (JS)
    participant ProductController
    participant ProductService
    participant ProductRepository
    participant DB as データベース

    User->>FE: 商品一覧ページへアクセス
    FE->>ProductController: GET /api/products
    ProductController->>ProductService: getAllProducts()
    ProductService->>ProductRepository: findAll()
    ProductRepository->>DB: SELECT * FROM products
    DB-->>ProductRepository: 商品データリスト
    ProductRepository-->>ProductService: List<Product>
    ProductService->>ProductService: ProductエンティティからProductListItem DTOへ変換
    ProductService-->>ProductController: List<ProductListItem>
    ProductController-->>FE: 商品リスト (JSON)
    FE-->>User: 商品一覧画面を表示

    User->>FE: 商品詳細をクリック
    FE->>ProductController: GET /api/products/{id}
    ProductController->>ProductService: getProductById(id)
    ProductService->>ProductRepository: findById(id)
    ProductRepository->>DB: SELECT * FROM products WHERE id=?
    DB-->>ProductRepository: Product
    ProductRepository-->>ProductService: Product
    ProductService->>ProductService: ProductエンティティからProductDetail DTOへ変換
    ProductService-->>ProductController: ProductDetail
    ProductController-->>FE: JSON (ProductDetail)
    FE-->>User: 商品詳細画面を表示
</div>

### 3.2.6. 自動入力シーケンス図

<div class="mermaid">
 sequenceDiagram
    participant User as ユーザー (Browser)
    participant FE as フロントエンド (JS)
    participant Session as セッション管理

    User->>FE: 注文フォームを開く
    FE->>Session: 顧客情報の取得 (ログイン中)
    Session-->>FE: Customer情報 (name, address, phone)
    FE-->>User: 注文フォームに自動入力表示
</div>

### 3.2.7. 注文確定通知シーケンス図

<div class="mermaid">
sequenceDiagram
    participant OrderService
    participant MailService
    participant User as ユーザー (メール受信者)

    OrderService->>MailService: sendOrderConfirmationEmail(order)
    MailService->>User: 注文確定メール送信 (order summary)
    MailService-->>OrderService: メール送信完了
</div>
## 4. クラス設計

ここでは、「シンプル雑貨オンライン」バックエンド（Spring Boot）アプリケーションのクラス構造について定義します。主要なパッケージ構成、クラス図、主要クラスの説明、およびデータ転送オブジェクト（DTO）の定義を示します。

### 4.1. 主要パッケージ構成
com.example.ecsite
├── controller
│   ├── ProductController         // 商品一覧・詳細取得
│   ├── CartController            // カート操作（セッション）
│   ├── OrderController           // 注文処理（非会員含む）
│   └── CustomerController        // 会員登録・ログイン・プロフィール更新
│
├── service
│   ├── ProductService
│   ├── CartService
│   ├── OrderService
│   └── CustomerService
│
├── repository
│   ├── ProductRepository
│   ├── OrderRepository
│   ├── OrderDetailRepository
│   └── CustomerRepository
│
├── entity
│   ├── Product                  // 商品情報
│   ├── Order                    // 注文情報
│   ├── OrderDetail              // 注文明細
│   └── Customer                 // 会員情報
│
├── dto
│   ├── ProductListItemDto       // 商品一覧表示用
│   ├── ProductDetailDto         // 商品詳細表示用
│   ├── CartDto                  // カート情報（セッション用）
│   ├── CartItemDto              // カート内アイテム
│   ├── CartItemInfo             // カート追加リクエスト
│   ├── CartItemQuantityDto      // カート数量変更リクエスト
│   ├── OrderRequestDto          // 注文リクエスト
│   ├── CustomerInfo             // 注文時の顧客情報（非会員）
│   ├── OrderResponseDto         // 注文完了レスポンス
│   ├── CustomerRegisterRequest  // 会員登録リクエスト
│   ├── LoginRequest             // ログインリクエスト
│   ├── CustomerUpdateRequest    // 会員情報更新リクエスト
│   ├── CustomerResponse         // 会員情報レスポンス
│   ├── OrderSummary             // 注文履歴一覧用
│   └── OrderItemSummary         // 注文履歴内商品の概要
│
└── exception                    // エラーハンドリング関連


## 4.2 クラス図
### 4.2.1. 商品関連クラス図
<div class='mermaid'>
classDiagram
    class ProductController {
        +ProductService productService
        +getAllProducts() ResponseEntity~List~ProductListItem~~
        +getProductById(productId) ResponseEntity~ProductDetail~
    }

    class ProductService {
        +ProductRepository productRepository
        +findAllProducts() List~ProductListItem~
        +findProductById(productId) ProductDetail
    }

    class ProductRepository {
        <<Interface>>
        +JpaRepository~Product, Integer~
        +findAll() List~Product~
        +findById(productId) Optional~Product~
    }

    class Product {
        <<Entity>>
        +Integer productId
        +String name
        +String description
        +Integer price
        +Integer stock
        +String imageUrl
        +Boolean isRecommended "Nullable"
        +LocalDateTime createdAt "Nullable"
        +LocalDateTime updatedAt "Nullable"
    }

    class ProductListItem {
        <<DTO>>
        +Integer productId
        +String name
        +Integer price
        +String imageUrl
    }

    class ProductDetail {
        <<DTO>>
        +Integer productId
        +String name
        +Integer price
        +String description
        +Integer stock
        +String imageUrl
    }

    %% 関連
    ProductController --> ProductService : uses
    ProductService --> ProductRepository : uses
    ProductRepository "1" -- "*" Product : manages

    ProductService ..> ProductListItem : creates
    ProductService ..> ProductDetail : creates
    ProductController ..> ProductListItem : returns
    ProductController ..> ProductDetail : returns
</div>

### 4.2.2. カート関連クラス図 (セッション管理)
<div class='mermaid'>
classDiagram
    class CartController {
        +CartService cartService
        +getCart(HttpSession) ResponseEntity~Cart~
        +addItem(CartItemInfo, HttpSession) ResponseEntity~Cart~
        +updateItem(itemId, CartItemQuantityDto, HttpSession) ResponseEntity~Cart~
        +removeItem(itemId, HttpSession) ResponseEntity~Cart~
    }

    class CartService {
        +ProductRepository productRepository
        +getCartFromSession(HttpSession) Cart
        +addItemToCart(productId, quantity, HttpSession) Cart
        +updateItemQuantity(itemId, quantity, HttpSession) Cart
        +removeItemFromCart(itemId, HttpSession) Cart
        +clearCart(HttpSession) void
    }

    class ProductRepository {
        <<Interface>>
        +findAll()
        +findById(id)
    }

    class Cart {
        <<DTO/Session Object>>
        +Map~String, CartItem~ items
        +int totalQuantity
        +int totalPrice
        +addItem(product, quantity) void
        +updateQuantity(itemId, quantity) void
        +removeItem(itemId) void
        +calculateTotals() void
    }

    class CartItem {
        <<DTO/Session Object>>
        +String id
        +Integer productId
        +String name
        +Integer price
        +String imageUrl
        +int quantity
        +int subtotal
    }

    class CartItemInfo {
        <<DTO>>
        +Integer productId
        +Integer quantity
    }

    class CartItemQuantityDto {
        <<DTO>>
        +Integer quantity
    }

    %% 関係
    CartController --> CartService : uses
    CartService --> ProductRepository : uses
    CartService ..> Cart : manages (in Session)
    CartService ..> CartItem : uses
    Cart "1" *-- "items *" CartItem : contains
    CartController ..> Cart : returns
    CartController ..> CartItemInfo : receives
    CartController ..> CartItemQuantityDto : receives

</div>

### 4.2.3. 注文関連クラス図 (非会員注文)
<div class='mermaid'>
classDiagram
    class OrderController {
        +OrderService orderService
        +CartService cartService
        +placeOrder(OrderRequest, HttpSession) ResponseEntity~OrderResponse~
    }

    class OrderService {
        +OrderRepository orderRepository
        +OrderDetailRepository orderDetailRepository
        +ProductRepository productRepository
        +CartService cartService
        +placeOrder(Cart, OrderRequest) OrderResponse
    }

    class OrderRepository {
        <<Interface>>
        +JpaRepository~Order, Integer~
    }

    class OrderDetailRepository {
        <<Interface>>
        +JpaRepository~OrderDetail, Integer~
        +saveAll(details) List~OrderDetail~
    }

    class ProductRepository {
        <<Interface>>
        +JpaRepository~Product, Integer~
    }


    class Order {
        <<Entity>>
        +Integer orderId
        +Customer customer
        +String orderEmail
        +String orderName
        +String orderPhoneNumber
        +String orderAddress
        +BigDecimal totalPrice
        +BigDecimal shippingFee
        +String paymentMethod
        +LocalDateTime orderDate
        +LocalDateTime createdAt
        +LocalDateTime updatedAt
    }

    class OrderDetail {
        <<Entity>>
        +Integer orderDetailId
        +Order order
        +Product product
        +Integer quantity
        +BigDecimal unitPrice
        +LocalDateTime createdAt
        +LocalDateTime updatedAt
    }

    class Product {
        <<Entity>>
        +Integer productId
        +String name
        +String description
        +Integer price
        +Integer stock
        +String imageUrl
    }

    class OrderRequest {
        <<DTO>>
        +CustomerInfo customerInfo // 非会員のみ使用
        +Integer memberId "Nullable"
    }

    class CustomerInfo {
        <<DTO>>
        +String name
        +String email
        +String address
        +String phoneNumber
    }

    class OrderResponse {
        <<DTO>>
        +Integer orderId
        +String orderNumber
        +LocalDateTime orderDate
        +Integer totalAmount
        +String status
    }

    %% 関連
    OrderController --> OrderService : uses
    OrderController --> CartService : uses
    OrderService --> OrderRepository : uses
    OrderService --> OrderDetailRepository : uses
    OrderService --> ProductRepository : uses
    OrderService --> CartService : uses

    OrderRepository "1" -- "*" Order : manages
    OrderDetailRepository "1" -- "*" OrderDetail : manages
    Order "1" -- "*" OrderDetail : contains (Cascade PERSIST/MERGE)
    OrderDetail "n" -- "1" Order : belongs to
    OrderDetail "n" -- "1" Product : refers to

    OrderController ..> OrderRequest : receives
    OrderController ..> OrderResponse : returns
    OrderService ..> OrderResponse : creates
</div>

### 4.2.4. 会員登録関連クラス図
<div class='mermaid'>
classDiagram
    class CustomerController {
        +CustomerService customerService
        +register(CustomerRegisterRequest) ResponseEntity~CustomerResponse~
        +login(LoginRequest) ResponseEntity~CustomerResponse~
        +updateProfile(CustomerUpdateRequest, HttpSession) ResponseEntity~CustomerResponse~
    }

    class CustomerService {
        +registerCustomer(CustomerRegisterRequest) CustomerResponse
        +authenticate(LoginRequest) CustomerResponse
        +updateCustomerInfo(CustomerUpdateRequest) CustomerResponse
        +getOrderHistory(customerId) List~OrderSummary~
    }

    class CustomerRepository {
        <<Interface>>
        +JpaRepository~Customer, Integer~
        +findByEmail(email) Optional~Customer~
    }

    class Customer {
        <<Entity>>
        +Integer customerId
        +String email
        +String password
        +String lastName
        +String firstName
        +String phoneNumber
        +String address
        +LocalDateTime createdAt
        +LocalDateTime updatedAt
    }

    class CustomerRegisterRequest {
        <<DTO>>
        +String name
        +String email
        +String password
        +String address
        +String phoneNumber
    }

    class LoginRequest {
        <<DTO>>
        +String email
        +String password
    }

    class CustomerUpdateRequest {
        <<DTO>>
        +String name
        +String email
        +String password "Optional"
        +String address
        +String phoneNumber
    }

    class CustomerResponse {
        <<DTO>>
        +Integer customerId
        +String name
        +String email
        +String address
        +String phoneNumber
    }

    class Order {
        <<Entity>>
        +Integer orderId
        +Customer customer
        +String orderEmail
        +String orderName
        +String orderPhoneNumber
        +String orderAddress
        +BigDecimal totalPrice
        +BigDecimal shippingFee
        +String paymentMethod
        +LocalDateTime orderDate
        +LocalDateTime createdAt
        +LocalDateTime updatedAt
    }

    class OrderSummary {
        <<DTO>>
        +Integer orderId
        +LocalDateTime orderDate
        +Integer totalAmount
        +List~OrderItemSummary~ items
    }

    class OrderItemSummary {
        <<DTO>>
        +String productName
        +Integer quantity
        +Integer price
    }

    %% 関連
    CustomerController --> CustomerService : uses
    CustomerService --> CustomerRepository : uses
    CustomerRepository --> Customer : manages
    Customer "1" -- "*" Order : places

    CustomerController ..> CustomerRegisterRequest : receives
    CustomerController ..> LoginRequest : receives
    CustomerController ..> CustomerUpdateRequest : receives
    CustomerController ..> CustomerResponse : returns
    CustomerService ..> CustomerResponse : creates
    CustomerService ..> OrderSummary : returns
</div>

## 4.3. 主要クラス説明

**Product**  
商品情報エンティティ（`productId`, `name`, `description`, `price`, `stock`, `imageUrl`, `isRecommended`, `createdAt`, `updatedAt`）

**Order**  
注文情報エンティティ（`orderId`, `orderNumber`, `orderDate`, `totalAmount`, `customerName`, `shippingAddress`, `shippingPhoneNumber`, `status`, `memberId`, `paymentMethod`, `paymentStatus`, `orderDetails`, `createdAt`, `updatedAt`）

**OrderDetail**  
注文明細エンティティ（`orderDetailId`, `order`, `product`, `productName`, `price`, `quantity`）

**Customer**  
会員情報エンティティ（`customerId`, `name`, `email`, `password`, `address`, `phoneNumber`, `createdAt`, `updatedAt`）

**CartDto**  
セッション保持用カート情報（`Map<String, CartItemDto> items`, `totalQuantity`, `totalPrice`）

**CartItemDto**  
カート内商品の情報（`id`, `productId`, `name`, `price`, `imageUrl`, `quantity`, `subtotal`）

**OrderRequestDto**  
注文リクエストDTO（`customerInfo`（非会員用）, `memberId`（会員注文用））

**CustomerInfo**  
非会員向け注文時の顧客情報DTO（`name`, `email`, `address`, `phoneNumber`）

**OrderResponseDto**  
注文完了レスポンスDTO（`orderId`, `orderNumber`, `orderDate`, `totalAmount`, `status`）

**CustomerRegisterRequest / LoginRequest / CustomerUpdateRequest**  
会員登録・ログイン・プロフィール更新用リクエストDTO（`name`, `email`, `password`, `address`, `phoneNumber` など）

**CustomerResponse**  
会員情報レスポンスDTO（`customerId`, `name`, `email`, `address`, `phoneNumber`）

**OrderSummary**  
注文履歴一覧表示用DTO（`orderId`, `orderDate`, `totalAmount`, `items`）

**OrderItemSummary**  
注文履歴の商品情報DTO（`productName`, `quantity`, `price`）

### 4.4. DTO定義
主要なAPIや機能で使用されるDTOの構造を示します。 (バリデーションルールは簡略化)

**商品関連 DTO**

```java
// 商品一覧用
public class ProductListItem {
    private Integer productId;
    private String name;
    private Integer price;
    private String imageUrl;

    public ProductListItem(Integer productId, String name, Integer price, String imageUrl) {
        this.productId = productId;
        this.name = name;
        this.price = price;
        this.imageUrl = imageUrl;
    }

    public Integer getProductId() { return productId; }
    public String getName() { return name; }
    public Integer getPrice() { return price; }
    public String getImageUrl() { return imageUrl; }
}

// 商品詳細用
public class ProductDetail {
    private Integer productId;
    private String name;
    private Integer price;
    private String description;
    private Integer stock;
    private String imageUrl;

    public ProductDetail(Integer productId, String name, Integer price, String description, Integer stock, String imageUrl) {
        this.productId = productId;
        this.name = name;
        this.price = price;
        this.description = description;
        this.stock = stock;
        this.imageUrl = imageUrl;
    }

    public Integer getProductId() { return productId; }
    public String getName() { return name; }
    public Integer getPrice() { return price; }
    public String getDescription() { return description; }
    public Integer getStock() { return stock; }
    public String getImageUrl() { return imageUrl; }
}
```
**カート関連 DTO** 

```java

// カート全体 (セッション格納/APIレスポンス用)
public class Cart {
    private Map<String, CartItem> items = new LinkedHashMap<>();
    private int totalQuantity;
    private int totalPrice;

    public Map<String, CartItem> getItems() { return items; }
    public int getTotalQuantity() { return totalQuantity; }
    public int getTotalPrice() { return totalPrice; }

    public void addItem(ProductListItem product, int quantity) {
        String key = product.getProductId().toString();
        if (items.containsKey(key)) {
            CartItem item = items.get(key);
            item.setQuantity(item.getQuantity() + quantity);
            item.updateSubtotal();
        } else {
            CartItem newItem = new CartItem(
                key,
                product.getProductId(),
                product.getName(),
                product.getPrice(),
                product.getImageUrl(),
                quantity
            );
            items.put(key, newItem);
        }
        calculateTotals();
    }

    public void updateQuantity(String id, int quantity) {
        CartItem item = items.get(id);
        if (item != null) {
            item.setQuantity(quantity);
            item.updateSubtotal();
        }
        calculateTotals();
    }

    public void removeItem(String id) {
        items.remove(id);
        calculateTotals();
    }

    public void calculateTotals() {
        totalQuantity = items.values().stream().mapToInt(CartItem::getQuantity).sum();
        totalPrice = items.values().stream().mapToInt(CartItem::getSubtotal).sum();
    }
}

// カート内商品 (セッション格納/APIレスポンス用)
public class CartItem {
    private String id;
    private Integer productId;
    private String name;
    private Integer price;
    private String imageUrl;
    private int quantity;
    private int subtotal;

    public CartItem(String id, Integer productId, String name, Integer price, String imageUrl, int quantity) {
        this.id = id;
        this.productId = productId;
        this.name = name;
        this.price = price;
        this.imageUrl = imageUrl;
        this.quantity = quantity;
        this.subtotal = price * quantity;
    }

    public String getId() { return id; }
    public Integer getProductId() { return productId; }
    public String getName() { return name; }
    public Integer getPrice() { return price; }
    public String getImageUrl() { return imageUrl; }
    public int getQuantity() { return quantity; }
    public int getSubtotal() { return subtotal; }

    public void setQuantity(int quantity) {
        this.quantity = quantity;
        updateSubtotal();
    }

    public void updateSubtotal() {
        this.subtotal = price * quantity;
    }
}

// カート追加APIリクエスト用
public class CartItemInfo {
    @NotNull
    private Integer productId;

    @NotNull
    @Min(1)
    private Integer quantity;

    public Integer getProductId() { return productId; }
    public void setProductId(Integer productId) { this.productId = productId; }

    public Integer getQuantity() { return quantity; }
    public void setQuantity(Integer quantity) { this.quantity = quantity; }
}

// カート数量更新APIリクエスト用
public class CartItemQuantityDto {
    @NotNull
    @Min(1)
    private Integer quantity;

    public Integer getQuantity() { return quantity; }
    public void setQuantity(Integer quantity) { this.quantity = quantity; }
}
```
**注文関連 DTO**

```java

// 注文APIリクエスト用
public class OrderRequest {
    @Valid
    @NotNull
    private CustomerInfo customerInfo;

    public CustomerInfo getCustomerInfo() { return customerInfo; }
    public void setCustomerInfo(CustomerInfo customerInfo) { this.customerInfo = customerInfo; }
}

// 注文APIリクエスト内の顧客情報用 (非会員用)
public class CustomerInfo {
    @NotBlank
    private String name;

    @NotBlank
    @Email
    private String email;

    @NotBlank
    private String address;

    @NotBlank
    private String phoneNumber;

    public String getName() { return name; }
    public void setName(String name) { this.name = name; }

    public String getEmail() { return email; }
    public void setEmail(String email) { this.email = email; }

    public String getAddress() { return address; }
    public void setAddress(String address) { this.address = address; }

    public String getPhoneNumber() { return phoneNumber; }
    public void setPhoneNumber(String phoneNumber) { this.phoneNumber = phoneNumber; }
}

// 注文APIレスポンス用
public class OrderResponse {
    private Integer orderId;
    private LocalDateTime orderDate;

    public OrderResponse(Integer orderId, LocalDateTime orderDate) {
        this.orderId = orderId;
        this.orderDate = orderDate;
    }

    public Integer getOrderId() { return orderId; }
    public LocalDateTime getOrderDate() { return orderDate; }
}
```

## 5. インターフェース仕様

### 5.1 API一覧
| API名   | API概要                               | HTTPメソッド | リクエストパラメータ                        | レスポンス内容                | エンドポイントURL         | 対象要素ID                             |
|---------|----------------------------------------|--------------|---------------------------------------------|-------------------------------|----------------------------|----------------------------------------|
| API_01  | カートに商品追加                       | POST         | 商品ID, 数量                                 | 成功可否／カート状態          | /api/cart/add              | C0202_B01                              |
| API_02  | ログイン処理                           | POST         | メールアドレス、パスワード                  | 成功可否／トークン等          | /api/login                 | C0601_B01                              |
| API_03  | ログアウト処理                         | POST         | セッションID                                | 成功可否                      | /api/logout                | C0603_B01                              |
| API_04  | 会員登録処理                           | POST         | 氏名、住所、電話番号、パスワード等          | 登録結果                      | /api/register              | C0501_B01                              |
| API_05  | 商品検索（商品一覧再表示）             | POST         | キーワード、カテゴリ、ページ番号等          | 商品一覧JSON                  | /api/products/search       | C0201_B01                              |
| API_06  | キーワード検索条件送信（トップページ） | POST         | キーワード                                  | 商品一覧JSON                  | /api/search                | C0101_TI01, C0201_TI01                 |
| API_07  | 商品一覧の繰り返し表示                 | GET          | カテゴリID、ページ番号など                   | 商品一覧JSON                  | /api/products/list         | C0201_L05                              |
| API_08  | 注文確定処理                           | POST         | 商品、顧客、配送先、支払情報等              | 注文番号／完了メッセージ      | /api/order/confirm         | C0402_B01                              |
| API_09  | 絞り込み解除（全商品表示）             | GET          | なし                                        | 全商品一覧JSON                | /api/products/all          | C0201_L04                              |
| API_10  | 注文情報確認（送料計算含む）           | POST         | カート商品、配送先、支払方法等              | 小計、送料、合計金額          | /api/order/preview         | C0401_B01                              |
| API_11  | 会員情報取得（マイページ等用）         | GET          | 認証トークン                                 | 氏名、住所、連絡先等          | /api/member/me             | C0603_D01                              |
| API_12  | 会員情報更新                           | PUT          | 氏名、住所、連絡先、パスワード等            | 更新結果                      | /api/member/me             | C0501_B01                              |
| API_13  | 注文履歴取得                           | GET          | 認証トークン                                 | 過去の注文一覧JSON            | /api/member/me/orders      | C0604_D01                              |


### 5.2 API詳細
本設計書では、代表的な2機能（カート追加・ログイン）についてAPI詳細（5.2）を記載し、それ以外のAPIは同様の形式・バリデーションに準拠して実装することを前提とする。
- カートに商品追加API
  - リクエスト JSON 形式
    ```
    {
    "email": "user@example.com",  // 必須、メールアドレス形式
    "password": "string"           // 必須、パスワード
    }
    ```

  - リクエストパラメータ詳細
    | パラメータ名   | 型      | 必須 | 説明             | バリデーション       |
    | -------- | ------ | -- | -------------- | ------------- |
    | email    | string | はい | 会員登録済みのメールアドレス | メールアドレス形式チェック |
    | password | string | はい | パスワード          | 空文字不可         |

  - パスパラメータ
    なし
  - レスポンスJSON形式
    ```
    {
    "success": true,
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",  // JWTなどの認証トークン
    "user": {
        "memberId": "string",
        "name": "string",
        "email": "user@example.com"
    }
    }
    ```

  - リクエスト JSON 形式
    ```
    {
    "productId": "string",    // 必須、商品ID
    "quantity": 1             // 必須、数量（1以上の整数）
    }
    ```
  - リクエストパラメータ詳細
    | パラメータ名    | 型      | 必須 | 説明        | バリデーション |
    | --------- | ------ | -- | --------- | ------- |
    | productId | string | はい | 追加する商品のID | 空文字不可   |
    | quantity  | int    | はい | 追加数量      | 1以上の整数  |
  - パスパラメータ
  なし
  - レスポンスJSON形式
    ```
    {
     "success": true,
    "cart": {
        "items": [
            {
            "productId": "string",
            "quantity": 1,
            "name": "string",
            "price": 1000
         }
        ],
        "totalPrice": 1000
        }
    }
     ```

   - レスポンスコード
        | コード | 説明                      |
        | --- | ----------------------- |
        | 200 | ログイン成功                  |
        | 400 | リクエストパラメータ不正            |
        | 401 | 認証失敗（メールアドレスまたはパスワード不正） |
        | 500 | サーバー内部エラー               |

    - エラー時のレスポンス例
     ```
    {
        "error": {
         "code": 401,
         "message": "Invalid email or password"
        }
     }
    ```
## 6. DB定義

本章では、本システムで使用するデータベース構造およびその設計方針を示す。以下の4つの項目で構成する。

---

### 6.1 テーブル定義書

本システムで使用する主要テーブルの物理設計を以下に示す。

---

#### CUSTOMER（顧客情報）

| 論理名           | 物理名        | 型        | サイズ | PK | NN | UQ | FK | CHK | デフォルト値      | 備考             |
|------------------|---------------|-----------|--------|----|----|----|----|-----|-------------------|------------------|
| 顧客ID           | customer_id   | INT       | -      | ○  | ○  |    |    |     | 自動採番          | 主キー           |
| ログイン用メールアドレス | email         | VARCHAR   | 255    |    | ○  | ○  |    |     |                   |                  |
| パスワード       | password      | VARCHAR   | 255    |    | ○  |    |    |     |                   | ハッシュ前提     |
| 姓               | last_name     | VARCHAR   | 50     |    | ○  |    |    |     |                   |                  |
| 名               | first_name    | VARCHAR   | 50     |    | ○  |    |    |     |                   |                  |
| 電話番号         | phone_number  | VARCHAR   | 20     |    | ○  |    |    |     |                   |                  |
| 配達先住所       | address       | TEXT      | -      |    | ○  |    |    |     |                   |                  |
| 登録日時         | created_at    | TIMESTAMP | -      |    | ○  |    |    |     | CURRENT_TIMESTAMP | 自動設定         |
| 更新日時         | updated_at    | TIMESTAMP | -      |    | ○  |    |    |     | CURRENT_TIMESTAMP | 自動更新（トリガ等） |

---

#### PRODUCT（商品情報）

| 論理名           | 物理名         | 型        | サイズ | PK | NN | UQ | FK | CHK                    | デフォルト値      | 備考                   |
|------------------|----------------|-----------|--------|----|----|----|----|-------------------------|-------------------|------------------------|
| 商品ID           | product_id     | INT       | -      | ○  | ○  |    |    |                         | 自動採番          |                        |
| 商品名           | product_name   | VARCHAR   | 255    |    | ○  |    |    |                         |                   |                        |
| 商品説明         | description    | TEXT      | -      |    |    |    |    |                         |                   |                        |
| 価格             | price          | DECIMAL   | 10     |    | ○  |    |    | price > 0               |                   |                        |
| 画像URL          | image_url      | VARCHAR   | 500    |    |    |    |    |                         |                   |                        |
| 素材             | material       | VARCHAR   | 100    |    |    |    |    |                         |                   |                        |
| サイズ           | size           | VARCHAR   | 100    |    |    |    |    |                         |                   |                        |
| カテゴリID       | category_id    | INT       | -      |    | ○  |    | ○  |                         |                   | → CATEGORY(category_id) |
| 在庫数           | stock_quantity | INT       | -      |    | ○  |    |    | stock_quantity >= 0     | 0                 |                        |
| 登録日時         | created_at     | TIMESTAMP | -      |    | ○  |    |    |                         | CURRENT_TIMESTAMP |                        |
| 更新日時         | updated_at     | TIMESTAMP | -      |    | ○  |    |    |                         | CURRENT_TIMESTAMP |                        |

---

#### CATEGORY（カテゴリ情報）

| 論理名           | 物理名        | 型        | サイズ | PK | NN | UQ | FK | CHK | デフォルト値      | 備考             |
|------------------|---------------|-----------|--------|----|----|----|----|-----|-------------------|------------------|
| カテゴリID       | category_id   | INT       | -      | ○  | ○  |    |    |     | 自動採番          | 主キー           |
| カテゴリ名       | category_name | VARCHAR   | 100    |    | ○  | ○  |    |     |                   | 一意制約あり     |
| 登録日時         | created_at    | TIMESTAMP | -      |    | ○  |    |    |     | CURRENT_TIMESTAMP |                  |
| 更新日時         | updated_at    | TIMESTAMP | -      |    | ○  |    |    |     | CURRENT_TIMESTAMP |                  |

---

#### ORDER（注文情報）

| 論理名              | 物理名           | 型        | サイズ | PK | NN | UQ | FK | CHK                         | デフォルト値      | 備考                      |
|---------------------|------------------|-----------|--------|----|----|----|----|------------------------------|-------------------|---------------------------|
| 注文ID              | order_id         | INT       | -      | ○  | ○  |    |    |                              | 自動採番          | 主キー                    |
| 顧客ID              | customer_id      | INT       | -      |    | ○  |    | ○  |                              |                   | → CUSTOMER(customer_id)   |
| 注文者メールアドレス | order_email      | VARCHAR   | 255    |    | ○  |    |    |                              |                   | 顧客情報のコピー          |
| 注文者氏名          | order_name       | VARCHAR   | 100    |    | ○  |    |    |                              |                   |                            |
| 注文者電話番号      | order_phone_number | VARCHAR | 20     |    | ○  |    |    |                              |                   |                            |
| 注文者住所          | order_address    | TEXT      | -      |    | ○  |    |    |                              |                   |                            |
| 合計金額            | total_price      | DECIMAL   | 10     |    | ○  |    |    | total_price > 0              |                   |                            |
| 配送料              | shipping_fee     | DECIMAL   | 10     |    | ○  |    |    |                              |                   |                            |
| 支払方法            | payment_method   | VARCHAR   | 50     |    | ○  |    |    | payment_method IN ('credit', 'bank', 'cash') | | |
| 注文日時            | order_date       | TIMESTAMP | -      |    | ○  |    |    |                              | CURRENT_TIMESTAMP |                            |
| データ登録日時      | created_at       | TIMESTAMP | -      |    | ○  |    |    |                              | CURRENT_TIMESTAMP |                            |

---

#### ORDER_DETAIL（注文明細情報）

| 論理名      | 物理名          | 型        | サイズ | PK | NN | UQ | FK | CHK                 | デフォルト値      | 備考                        |
|-------------|-----------------|-----------|--------|----|----|----|----|----------------------|-------------------|-----------------------------|
| 注文明細ID  | order_detail_id | INT       | -      | ○  | ○  |    |    |                      | 自動採番          | 主キー                      |
| 注文ID      | order_id        | INT       | -      |    | ○  |    | ○  |                      |                   | → ORDER(order_id)          |
| 商品ID      | product_id      | INT       | -      |    | ○  |    | ○  |                      |                   | → PRODUCT(product_id)      |
| 数量        | quantity        | INT       | -      |    | ○  |    |    | quantity > 0         |                   |                            |
| 購入時価格  | unit_price      | DECIMAL   | 10     |    | ○  |    |    | unit_price > 0       |                   |                            |
| 登録日時    | created_at      | TIMESTAMP | -      |    | ○  |    |    |                      | CURRENT_TIMESTAMP |                            |
| 更新日時    | updated_at      | TIMESTAMP | -      |    | ○  |    |    |                      | CURRENT_TIMESTAMP |                            |

---

### 6.2 ER図

```mermaid
erDiagram
    CUSTOMER ||--o{ ORDER : has
    ORDER ||--o{ ORDER_DETAIL : contains
    PRODUCT ||--o{ ORDER_DETAIL : includes
    PRODUCT }o--|| CATEGORY : belongs_to

    CUSTOMER {
        int customer_id PK
        string email
        string password
        string last_name
        string first_name
        string phone_number
        string address
        datetime created_at
        datetime updated_at
    }

    PRODUCT {
        int product_id PK
        string product_name
        string description
        decimal price
        string image_url
        string material
        string size
        int category_id FK
        int stock_quantity
        datetime created_at
        datetime updated_at
    }

    CATEGORY {
        int category_id PK
        string category_name
        datetime created_at
        datetime updated_at
    }

    ORDER {
        int order_id PK
        int customer_id FK
        string order_email
        string order_name
        string order_phone_number
        string order_address
        decimal total_price
        decimal shipping_fee
        string payment_method
        datetime order_date
        datetime created_at
    }

    ORDER_DETAIL {
        int order_detail_id PK
        int order_id FK
        int product_id FK
        int quantity
        decimal unit_price
        datetime created_at
        datetime updated_at
    }
```

### 6.3 インデックス一覧

| テーブル名   | インデックス名       | 対象カラム   | 用途・補足                     |
|--------------|----------------------|--------------|-------------------------------|
| CUSTOMER     | idx_customer_email   | email        | ログイン認証用ユニーク検索     |
| PRODUCT      | idx_product_category | category_id  | 商品一覧のカテゴリ絞り込み     |
| ORDER        | idx_order_customer   | customer_id  | 顧客別注文履歴の高速検索       |
| ORDER_DETAIL | idx_detail_order     | order_id     | 注文明細の注文単位検索         |
| ORDER_DETAIL | idx_detail_product   | product_id   | 商品別の注文明細検索           |

※ 主キーにはデフォルトでユニークインデックスが作成される。

---

### 6.4 トランザクション設計方針

#### 基本方針

- 関連データ操作（特に注文処理・会員登録）においては、**トランザクション処理で整合性を担保**
- 複数テーブルにまたがる処理は原子性（Atomicity）を確保し、**失敗時にはロールバック**
- **排他制御（SELECT FOR UPDATEなど）**　を用いて同時更新を防止

#### トランザクション対象処理例

| 処理名       | 対象テーブル              | ロールバック条件             |
|--------------|---------------------------|------------------------------|
| 注文確定処理 | ORDER, ORDER_DETAIL       | いずれかのINSERT失敗         |
| 会員登録処理 | CUSTOMER                  | INSERT失敗                   |
| 会員情報更新 | CUSTOMER                  | UPDATE失敗                   |
| 在庫更新     | PRODUCT                   | UPDATE失敗                   |

#### 排他制御

- 商品在庫の更新には `SELECT FOR UPDATE` を使用
- トランザクションの粒度は「画面単位」とし、ロックは必要最小限に限定

## 7. 画面項目定義
### 7.1 画面一覧
![](画面UI/C0101C0201.png)
![](画面UI/C0202C0301.png)
![](画面UI/C0401C0402.png)
![](画面UI/C0403C0501.png)
![](画面UI/C0601C0603.png)
![](画面UI/C0604C0605.png)
![](画面UI/C0701C0801.png)
![](画面UI/C0901C1001.png)

### 7.2 画面項目定義書
| 要素ID       | 画面ID | 項目名               | 要素種別           | 動作・備考                                   | 桁数制限     | バリデーションルール                               | エラーメッセージ                          |
|--------------|--------|----------------------|--------------------|----------------------------------------------|--------------|----------------------------------------------------|-------------------------------------------|
| C0101_L01    | C0101  | ○○ECサイト           | リンク             | トップページ(C0101)に遷移                    | なし         |                                                    |                                           |
| C0101_L02    | C0101  | カート               | リンク             | カート(C0301)に遷移                          | なし         |                                                    |                                           |
| C0101_L03    | C0101  | ログイン             | リンク             | ログイン(C0601)に遷移                        | なし         |                                                    |                                           |
| C0101_TI01   | C0101  | キーワード検索       | テキスト入力       | 入力内容を検索条件として送信                  | 最大50文字   | 全角・半角文字、数字を許容。記号（"・"など）も可 | キーワードは50文字以内で入力してください |
| C0101_B01    | C0101  | 検索                 | ボタン             | 入力値をパラメータとして送信、商品一覧（C0201）に遷移 | なし         |                                                    |                                           |
| C0101_D01    | C0101  | カテゴリから選ぶ     | 表示項目           | ラベル                                       | なし         |                                                    |                                           |
| C0101_L04    | C0101  | 文房具               | リンク             | カテゴリ絞り込みで商品一覧（C0201）に遷移   | なし         |                                                    |                                           |
| C0101_L05    | C0101  | キッチン用品         | リンク             | カテゴリ絞り込みで商品一覧（C0201）に遷移   | なし         |                                                    |                                           |
| C0101_L06    | C0101  | 生活雑貨             | リンク             | カテゴリ絞り込みで商品一覧（C0201）に遷移   | なし         |                                                    |                                           |
| C0101_L07    | C0101  | インテリア           | リンク             | カテゴリ絞り込みで商品一覧（C0201）に遷移   | なし         |                                                    |                                           |
| C0101_L08    | C0101  | 特定商取引法表示     | リンク             | 特定商取引法表示(C0701)に遷移                | なし         |                                                    |                                           |
| C0101_L09    | C0101  | プライバシーポリシー | リンク             | プライバシーポリシー(C0801)に遷移            | なし         |                                                    |                                           |
| C0101_L10    | C0101  | FAQ                  | リンク             | FAQ(C0901)に遷移                            | なし         |                                                    |                                           |
| C0201_L01    | C0201  | ○○ECサイト           | リンク             | トップページ(C0101)に遷移                    | なし         |                                                    |                                           |
| C0201_L02    | C0201  | カート               | リンク             | カート(C0301)に遷移                          | なし         |                                                    |                                           |
| C0201_L03    | C0201  | ログイン             | リンク             | ログイン(C0601)に遷移                        | なし         |                                                    |                                           |
| C0201_TI01   | C0201  | キーワード検索       | テキスト入力       | 入力内容を検索条件として送信                  | 最大50文字   | 全角・半角文字、数字を許容。記号（"・"など）も可 | キーワードは50文字以内で入力してください |
| C0201_B01    | C0201  | 検索                 | ボタン             | 入力値をパラメータとして送信、商品一覧再表示 | なし         |                                                    |                                           |
| C0201_SB01   | C0201  | カテゴリを絞り込む   | セレクトボックス   | 選択後、カテゴリに応じて商品一覧に遷移       | なし         |                                                    |                                           |
| C0201_L04    | C0201  | すべての商品を表示   | リンク             | 絞り込み解除、全商品一覧を表示               | なし         |                                                    |                                           |
| C0201_L05    | C0201  | 商品一覧リスト       | 繰り返しリンク     | 各商品ブロックリンクを繰り返し表示           | なし         |                                                    |                                           |
| C0201_D01    | C0201  | 画像                 | 表示項目           | 商品画像表示                                 | なし         |                                                    |                                           |
| C0201_D02    | C0201  | 商品名               | 表示項目           | 商品名テキスト表示                           | なし         |                                                    |                                           |
| C0201_D03    | C0201  | 価格                 | 表示項目           | 価格表示（税込）                             | なし         |                                                    |                                           |
| C0201_L06    | C0201  | >                    | リンク             | 商品詳細(0202)に遷移                         | なし         |                                                    |                                           |
| C0202_L01    | C0202  | ○○ECサイト           | リンク             | トップページ(C0101)に遷移                    | なし         |                                                    |                                           |
| C0202_L02    | C0202  | カート               | リンク             | カート(C0301)に遷移                          | なし         |                                                    |                                           |
| C0202_L03    | C0202  | ログイン             | リンク             | ログイン(C0601)に遷移                        | なし         |                                                    |                                           |
| C0202_D01    | C0202  | 商品名               | 表示項目           | 商品名を表示                               | なし         |                                                    |                                           |
| C0202_D02    | C0202  | 写真                 | 表示項目           | 商品画像の大きい表示                         | なし         |                                                    |                                           |
| C0202_B01    | C0202  | カートに入れる       | ボタン             | カート(C0301)へ商品追加                      | なし         |                                                    |                                           |
| C0202_D03    | C0202  | 価格                 | 表示項目           | 価格表示                                   | なし         |                                                    |                                           |
| C0202_D04    | C0202  | 商品スペック         | 表示項目           | 商品の詳細仕様（サイズ、素材など）           | なし         |                                                    |                                           |
| C0301_L01    | C0301  | ○○ECサイト           | リンク             | トップページ(C0101)に遷移                    | なし         |                                                    |                                           |
| C0301_L02    | C0301  | カート               | リンク             | カート(C0301)に遷移                          | なし         |                                                    |                                           |
| C0301_L03    | C0301  | ログイン             | リンク             | ログイン(C0601)に遷移                        | なし         |                                                    |                                           |
| C0301_D01    | C0301  | ショッピングカート   | 表示項目           | カート内商品の一覧表示                       | なし         |                                                    |                                           |
| C0301_D02    | C0301  | 商品ブロック         | 表示項目           | 各商品1件分の情報ブロック                   | なし         |                                                    |                                           |
| C0301_D03    | C0301  | 写真                 | 表示項目           | 商品画像表示                               | なし         |                                                    |                                           |
| C0301_D04    | C0301  | 商品名               | 表示項目           | 商品名表示                                 | なし         |                                                    |                                           |
| C0301_D05    | C0301  | 価格                 | 表示項目           | 価格表示                                   | なし         |                                                    |                                           |
| C0301_NS01   | C0301  | 数量                 | 数値入力＋スピンボタン | 「＋」「－」で数量を変更                  | 1～999       | （初期値1、0未満不可）                           |                                           |
| C0301_D06    | C0301  | 合計金額             | 表示項目           | 商品合計金額表示                           | なし         |                                                    |                                           |
| C0301_D07    | C0301  | 送料無料条件         | 表示項目           | ご注文金額￥5,000以上で送料無料表示         | なし         |                                                    |                                           |
| C0301_L04    | C0301  | 買い物を続ける       | リンク             | 商品一覧(C0201)に遷移                       | なし         |                                                    |                                           |
| C0301_L05    | C0301  | 購入手続きへ進む     | リンク             | 注文情報入力(C0401)に遷移                   | なし         |                                                    |                                           |
| C0401_L01    | C0401  | ○○ECサイト           | リンク             | トップページ(C0101)に遷移                    | なし         |                                                    |                                           |
| C0401_D01    | C0401  | ご注文商品           | 表示項目           | 注文商品一覧表示                           | なし         |                                                    |                                           |
| C0401_D02    | C0401  | 商品名               | 表示項目           | 商品名表示                                 | なし         |                                                    |                                           |
| C0401_D03    | C0401  | 数量                 | 表示項目           | 注文数量表示                               | なし         |                                                    |                                           |
| C0401_D04    | C0401  | 価格                 | 表示項目           | 単価表示                                   | なし         |                                                    |                                           |
| C0401_D05    | C0401  | 商品小計（点数）     | 表示項目           | 小計金額、購入点数表示                     | なし         |                                                    |                                           |
| C0401_D06    | C0401  | 送料                 | 表示項目           | ￥500（合計金額が￥5000未満）or￥０（合計金額が￥5000以上） | なし         |                                                    |                                           |
| C0401_D07    | C0401  | 合計金額             | 表示項目           | 合計金額表示                               | なし         |                                                    |                                           |
| C0401_D08    | C0401  | お届け先             | 表示項目           | お届け先情報ブロック                       | なし         |                                                    |                                           |
| C0401_D09    | C0401  | 氏名                 | 表示項目           | お届け先氏名表示                           | なし         |                                                    |                                           |
| C0401_TI01   | C0401  | 姓入力欄             | テキスト入力       | 氏名の姓入力                               | 最大20文字   | 全角・半角文字を許容。英字・日本語どちらも可     | 姓は20文字以内で入力してください           |
| C0401_TI02   | C0401  | 名入力欄             | テキスト入力       | 氏名の名入力                               | 最大20文字   | 全角・半角文字を許容。英字・日本語どちらも可     | 名は20文字以内で入力してください           |
| C0401_D10    | C0401  | 〒                    | 表示項目           | 郵便番号ラベル                           | なし         |                                                    |                                           |
| C0401_TI03   | C0401  | 郵便番号入力欄       | テキスト入力       | 郵便番号入力                               | 固定7桁     | 数字7桁（ハイフンなし）                           | 郵便番号はハイフンなし半角数字7桁で入力してください（例：1234567） |
| C0401_D11    | C0401  | 住所                 | 表示項目           | 住所ラベル                                 | なし         |                                                    |                                           |
| C0401_TI04   | C0401  | 住所入力欄           | テキスト入力       | 住所入力                                   | 最大100文字 | 全角・半角文字、数字、「-」等の記号を許容           | 住所は100文字以内で入力してください           |
| C0401_D12    | C0401  | 電話番号             | 表示項目           | 電話番号ラベル                             | なし         |                                                    |                                           |
| C0401_TI05   | C0401  | 電話番号入力欄       | テキスト入力       | 電話番号入力                               | 最大15文字  | 数字のみ（ハイフンなし）                           | 電話番号は15桁以内のハイフンなし半角数字で入力してください     |
| C0401_D13    | C0401  | メールアドレス       | 表示項目           | メールラベル                               | なし         |                                                    |                                           |
| C0401_TI06   | C0401  | メールアドレス入力欄 | テキスト入力       | メールアドレス入力                         | 最大254文字 | 「xxx@yyy.zzz」形式（RFC準拠）。（半角英数字）        | 有効なメールアドレスを入力してください             |
| C0401_D14    | C0401  | お支払方法           | 表示項目           | 支払方法ラベル                             | なし         |                                                    |                                           |
| C0401_RB01   | C0401  | 代金引換             | ラジオボタン       | 支払方法選択肢                             | なし         |                                                    |                                           |
| C0401_RB02   | C0401  | 銀行振込             | ラジオボタン       | 支払方法選択肢                             | なし         |                                                    |                                           |
| C0401_B01    | C0401  | 注文確認へ           | ボタン             | 注文確認画面(C0402)に遷移                 | なし         |                                                    |                                           |
| C0402_D01    | C0402  | ご注文商品           | 表示項目           | 注文商品一覧表示                           | なし         |                                                    |                                           |
| C0402_D02    | C0402  | 商品名               | 表示項目           | 商品名表示                                 | なし         |                                                    |                                           |
| C0402_D03    | C0402  | 数量                 | 表示項目           | 注文数量表示                               | なし         |                                                    |                                           |
| C0402_D04    | C0402  | 価格                 | 表示項目           | 単価表示                                   | なし         |                                                    |                                           |
| C0402_D05    | C0402  | 商品小計（点数）     | 表示項目           | 小計点数表示                               | なし         |                                                    |                                           |
| C0402_D06    | C0402  | 送料                 | 表示項目           | 送料表示                                   | なし         |                                                    |                                           |
| C0402_D07    | C0402  | 合計金額             | 表示項目           | 合計金額表示                               | なし         |                                                    |                                           |
| C0402_D08    | C0402  | お届け先             | 表示項目           | お届け先情報表示                           | なし         |                                                    |                                           |
| C0402_D09    | C0402  | 氏名                 | 表示項目           | 氏名表示                                   | なし         |                                                    |                                           |
| C0402_D10    | C0402  | 〒                    | 表示項目           | 郵便番号表示                             | なし         |                                                    |                                           |
| C0402_D11    | C0402  | 住所                 | 表示項目           | 住所表示                                   | なし         |                                                    |                                           |
| C0402_D12    | C0402  | 電話番号             | 表示項目           | 電話番号表示                               | なし         |                                                    |                                           |
| C0402_D13    | C0402  | メールアドレス       | 表示項目           | メールアドレス表示                         | なし         |                                                    |                                           |
| C0402_D14    | C0402  | お支払方法           | 表示項目           | 支払方法表示                               | なし         |                                                    |                                           |
| C0402_B01    | C0402  | 注文を確定する       | ボタン             | 注文確定処理実行                           | なし         |                                                    |                                           |
| C0403_L01    | C0403  | ○○ECサイト           | リンク             | トップページ(C0101)に遷移                  | なし         |                                                    |                                           |
| C0403_D01    | C0403  | 購入ありがとう       | 表示項目           | 購入ありがとうございます。注文明細をメールで送付しました。 | なし         |                                                    |                                           |
| C0403_D02    | C0403  | 注文番号             | 表示項目           | 注文番号表示                               | なし         |                                                    |                                           |
| C0403_L02    | C0403  | トップページへ       | リンク             | トップページ(C0101)に遷移                  | なし         |                                                    |                                           |
| C0501_L01    | C0501  | ○○ECサイト           | リンク             | トップページ(C0101)に遷移                  | なし         |                                                    |                                           |
| C0501_D01    | C0501  | 会員情報のご登録     | 表示項目           | 画面タイトル                               | なし         |                                                    |                                           |
| C0501_D02    | C0501  | 会員ID               | 表示項目           | 会員ID表示（変更不可）                     | なし         |                                                    |                                           |
| C0501_TI01   | C0501  | メールアドレス入力欄 | テキスト入力       | メールアドレス入力                         | 最大254文字 | 「xxx@yyy.zzz」形式（RFC準拠）。（半角英数字）        | 有効なメールアドレスを入力してください             |
| C0501_D03    | C0501  | パスワード           | 表示項目           | ラベル                                     | なし         |                                                    |                                           |
| C0501_TI02   | C0501  | パスワード入力欄     | テキスト入力       | パスワード入力                             | 8～32文字   | 半角英字・数字。記号（@#$など）も可                   | パスワードは8～32文字の半角英数字で入力してください     |
| C0501_D04    | C0501  | パスワード確認       | 表示項目           | ラベル                                     | なし         |                                                    |                                           |
| C0501_TI03   | C0501  | パスワード入力欄     | テキスト入力       | 確認用パスワード入力                       | 8～32文字   | 同一画面内のパスワード入力欄の値と一致していること     | 確認用パスワードが一致しません                   |
| C0501_D05    | C0501  | 氏名                 | 表示項目           | ラベル                                     | なし         |                                                    |                                           |
| C0501_TI04   | C0501  | 姓入力欄             | テキスト入力       | 氏名の姓入力                               | 最大20文字 | 全角・半角文字を許容。英字・日本語どちらも可           | 姓は20文字以内で入力してください                   |
| C0501_TI05   | C0501  | 名入力欄             | テキスト入力       | 氏名の名入力                               | 最大20文字 | 全角・半角文字を許容。英字・日本語どちらも可           | 名は20文字以内で入力してください                   |
| C0501_D06    | C0501  | 〒                    | 表示項目           | 郵便番号ラベル                             | なし         |                                                    |                                           |
| C0501_TI06   | C0501  | 郵便番号入力欄       | テキスト入力       | 郵便番号入力                               | 固定7桁     | 数字7桁（ハイフンなし）                               | 郵便番号はハイフンなし半角数字7桁で入力してください（例：1234567） |
| C0501_D07    | C0501  | 住所                 | 表示項目           | ラベル                                     | なし         |                                                    |                                           |
| C0501_TI07   | C0501  | 住所入力欄           | テキスト入力       | 住所入力                                   | 最大100文字 | 全角・半角文字、数字、「-」等の記号を許容               | 住所は100文字以内で入力してください                   |
| C0501_D08    | C0501  | 電話番号             | 表示項目           | ラベル                                     | なし         |                                                    |                                           |
| C0501_TI08   | C0501  | 電話番号入力欄       | テキスト入力       | 電話番号入力                               | 最大15文字 | 数字のみ（ハイフンなし）                               | 電話番号は15桁以内のハイフンなし半角数字で入力してください     |
| C0501_B01    | C0501  | 登録する             | ボタン             | 会員登録処理                               | なし         |                                                    |                                           |
| C0601_L01    | C0601  | ○○ECサイト           | リンク             | トップページ(C0101)に遷移                  | なし         |                                                    |                                           |
| C0601_D01    | C0601  | ログイン             | 表示項目           | 画面タイトル                               | なし         |                                                    |                                           |
| C0601_D02    | C0601  | 会員のお客様         | 表示項目           | ラベル                                     | なし         |                                                    |                                           |
| C0601_TI01   | C0601  | メールアドレス入力欄 | テキスト入力       | メールアドレス入力                         | 最大254文字 | 「xxx@yyy.zzz」形式（RFC準拠）。（半角英数字）            | 有効なメールアドレスを入力してください             |
| C0601_D03    | C0601  | パスワード           | 表示項目           | ラベル                                     | なし         |                                                    |                                           |
| C0601_TI02   | C0601  | パスワード入力欄     | テキスト入力       | パスワード入力                             | 8～32文字   | 半角英字・数字。記号（@#$など）も可                     | パスワードは8～32文字の半角英数字で入力してください     |
| C0601_B01    | C0601  | ログイン             | ボタン             | ログイン処理                               | なし         |                                                    |                                           |
| C0601_L02    | C0601  | はじめてご利用のお客様 | リンク             | 会員登録画面(C0501)に遷移                 | なし         |                                                    |                                           |
| C0603_L01    | C0603  | ○○ECサイト           | リンク             | トップページ(C0101)に遷移                  | なし         |                                                    |                                           |
| C0603_L02    | C0603  | カート               | リンク             | カート(C0301)に遷移                        | なし         |                                                    |                                           |
| C0603_L03    | C0603  | ログイン             | リンク             | ログイン(C0601)に遷移                      | なし         |                                                    |                                           |
| C0603_D01    | C0603  | 姓　さんの会員ページ | 表示項目           | ログインユーザー名表示                     | なし         |                                                    |                                           |
| C0603_L04    | C0603  | ご注文履歴           | リンク             | 注文履歴画面(C0604)に遷移                 | なし         |                                                    |                                           |
| C0603_L05    | C0603  | 登録情報の確認・変更 | リンク             | 会員情報変更画面(C0501)に遷移             | なし         |                                                    |                                           |
| C0603_B01    | C0603  | ログアウト           | ボタン             | ログアウト処理                             | なし         |                                                    |                                           |
| C0604_L01    | C0604  | ○○ECサイト           | リンク             | トップページ(C0101)に遷移                  | なし         |                                                    |                                           |
| C0604_L02    | C0604  | カート               | リンク             | カート(C0301)に遷移                        | なし         |                                                    |                                           |
| C0604_L03    | C0604  | ログイン             | リンク             | ログイン(C0601)に遷移                      | なし         |                                                    |                                           |
| C0604_D01    | C0604  | ご注文履歴           | 表示項目           | 注文履歴一覧表示                         | なし         |                                                    |                                           |
| C0604_D02    | C0604  | 注文日               | 表示項目           | 注文日表示                                 | なし         |                                                    |                                           |
| C0604_D03    | C0604  | 注文番号             | 表示項目           | 注文番号表示                               | なし         |                                                    |                                           |
| C0604_D04    | C0604  | 配達状況             | 表示項目           | 配達状況表示                               | なし         |                                                    |                                           |
| C0604_D05    | C0604  | 商品名               | 表示項目           | 商品名表示                                 | なし         |                                                    |                                           |
| C0604_D06    | C0604  | 価格                 | 表示項目           | 価格表示                                   | なし         |                                                    |                                           |
| C0604_D07    | C0604  | 数量                 | 表示項目           | 数量表示                                   | なし         |                                                    |                                           |
| C0604_B01    | C0604  | マイページへ         | ボタン             | マイページ(C0603)に遷移                   | なし         |                                                    |                                           |
| C0605_L01    | C0605  | ○○ECサイト           | リンク             | トップページ(C0101)に遷移                  | なし         |                                                    |                                           |
| C0605_D01    | C0605  | ご注文手続きを始めます | 表示項目           | 画面タイトル                               | なし         |                                                    |                                           |
| C0605_B01    | C0605  | ログインして購入する | ボタン             | ログイン画面(C0601)に遷移                 | なし         |                                                    |                                           |
| C0605_D02    | C0605  | 会員ID               | 表示項目           | ラベル                                     |              |                                                    |                                           |
| C0605_TI01   | C0605  | メールアドレス入力欄 | テキスト入力       | メールアドレス入力                         | 最大254文字 | 「xxx@yyy.zzz」形式（RFC準拠）。（半角英数字）            | 有効なメールアドレスを入力してください             |
| C0605_D03    | C0605  | パスワード           | 表示項目           | ラベル                                     | なし         |                                                    |                                           |
| C0605_TI02   | C0605  | パスワード入力欄     | テキスト入力       | パスワード入力                             | 8～32文字   | 半角英字・数字。記号（@#$など）も可                     | パスワードは8～32文字の半角英数字で入力してください     |
| C0605_B02    | C0605  | 会員登録して購入する | ボタン             | 会員登録画面(C0501)に遷移                 | なし         |                                                    |                                           |
| C0605_L02    | C0605  | 新規会員登録へ       | リンク             | 会員登録画面(C0501)に遷移                 | なし         |                                                    |                                           |
| C0605_B03    | C0605  | 会員登録しないで購入する | ボタン             | ゲスト購入手続き(C0401)に遷移             | なし         |                                                    |                                           |
| C0605_B04    | C0605  | 購入手続きへ         | ボタン             | 注文情報入力(C0401)に遷移                 | なし         |                                                    |                                           |
| C0701_L01    | C0701  | ○○ECサイト           | リンク             | トップページ(C0101)に遷移                  | なし         |                                                    |                                           |
| C0701_D01    | C0701  | 特定商取引法に関する表示 | 表示項目           | 特定商取引法表示表示                       | なし         |                                                    |                                           |
| C0801_L01    | C0801  | ○○ECサイト           | リンク             | トップページ(C0101)に遷移                  | なし         |                                                    |                                           |
| C0801_D01    | C0801  | プライバシーポリシー | 表示項目           | プライバシーポリシー表示                   | なし         |                                                    |                                           |
| C0901_L01    | C0901  | ○○ECサイト           | リンク             | トップページ(C0101)に遷移                  | なし         |                                                    |                                           |
| C0901_D01    | C0901  | FAQ                  | 表示項目           | FAQ表示                                   | なし         |                                                    |                                           |
| C1001_L01    | C1001  | ○○ECサイト           | リンク             | トップページ(C0101)に遷移                  | なし         |                                                    |                                           |
| C1001_D01    | C1001  | エラーが発生しました | 表示項目           | エラーメッセージ表示                       | なし         |                                                    |                                           |
| C1001_L02    | C1001  | トップページへ       | リンク             | トップページ(C0101)に遷移                  | なし         |                                                    |                                           |



### 7.3 共通エラーメッセージ一覧
共通エラー画面(C1001)を表示
## 8. 非機能要件詳細

### 8.1 セキュリティ

**認証・認可**
- 認証はセッションベース（HTTP Cookie）で実施し、ログイン後にセッションIDを発行し、ブラウザのCookieに格納して認証に利用する。
- 認可はロールベースアクセス制御（RBAC）を採用し、一般ユーザを対象に各画面・API単位でアクセス権限を定義する。
- セッションIDはHTTPOnly属性とSecure属性を設定し、JavaScriptから参照できないようにしつつHTTPS通信限定とする。

**通信の保護**
- 全ての通信はHTTPS（TLS1.2以上）により暗号化し、平文データが送信されないようにする。
- サーバ証明書の期限は監視対象とし、有効期限切れがないよう自動更新または計画的な差替を行う。

**アプリケーションレベルの対策**
- SQLインジェクション対策として、プリペアドステートメント（PreparedStatement）を使用し、ユーザ入力はすべてバインド変数を通じて処理する。
- XSS対策として、出力箇所で適切なHTMLエスケープを行い、ヘッダに `X-Frame-Options: DENY`、`X-Content-Type-Options: nosniff` を付与する。
- 外部からの入力は全項目でサーバサイドバリデーションを実施し、不正値が登録・処理されないようにする。

---

### 8.2 性能

**性能目標**
- API・画面表示のレスポンスは通常時に3秒以内の応答を目指す。
- データベースアクセス（一般的なSELECT）は0.1秒未満で完了することを基準とする。

**実現のための工夫**
- ページネーション（limit/offset）を用い、大量データを一括返却しない設計とする。
- 頻繁に検索されるカラムや条件にインデックスを設定し、テーブルフルスキャンを回避する。
- マスタ系データはアプリケーション起動時にメモリにキャッシュする方式を採用し、DBアクセス回数を抑制する。
- N+1問題を避けるため、ORM（JPA/Hibernate）のFetchTypeを適切に設定し、必要に応じてJOIN FETCHでまとめて取得する。

---

### 8.3 可用性

**可用性確保の方針**
- プロセスは `systemd` により監視し、異常終了時には自動再起動する設定を行う。
- データベースは単一構成（シンプルなマスタのみ）としつつ、障害発生時には手動で迅速に復旧できる手順を整備する。

---

### 8.4 バックアップ・リストア

**バックアップ**
- データベースは `pg_dump` による日次フルバックアップを取得し、必要に応じてWALアーカイブ（Write Ahead Log）を利用し、増分リカバリを可能とする。
- ファイルアップロードを伴う場合はアップロードディレクトリも同様に日次でスナップショットを取得する。

**リストア**
- 障害発生時は、直近の `pg_dump` バックアップをリストア後、WALファイルを適用して障害発生直前まで復旧する。
- アプリケーションサーバ障害時は、新規インスタンスへ再デプロイし設定ファイルを復元することで短時間で復旧する。
