## 4.5 シーケンス図
### 4.5.1. 購入フローシーケンス図

<div class="mermaid">
sequenceDiagram
    %% No.1: 購入フロー一式
    participant User as ユーザー (Browser)
    participant FE as フロントエンド (JS)
    participant CartController
    participant CartService
    participant ProductRepository
    participant OrderController
    participant OrderService
    participant OrderRepository
    participant OrderDetailRepository
    participant MailService
    participant DB as データベース

    User->>FE: 商品をカートに追加
    FE->>CartController: POST /api/cart/add
    CartController->>CartService: addItem(productId, qty, session)
    CartService->>ProductRepository: findById(productId)
    ProductRepository->>DB: SELECT * FROM products WHERE id=?
    DB-->>ProductRepository: Product
    ProductRepository-->>CartService: Product
    CartService-->>CartController: Updated Cart
    CartController-->>FE: JSON (Updated Cart)
    FE-->>User: カートを表示

    User->>FE: 購入手続き
    FE->>OrderController: POST /api/orders
    OrderController->>OrderService: placeOrder(cart, orderRequest)
    OrderService->>OrderRepository: save(Order)
    OrderRepository->>DB: INSERT INTO orders ...
    DB-->>OrderRepository: Order ID
    OrderService->>OrderDetailRepository: saveAll(OrderDetails)
    OrderDetailRepository->>DB: INSERT INTO order_details ...
    DB-->>OrderDetailRepository: Success
    OrderService->>MailService: sendOrderConfirmationEmail()
    MailService->>User: 確認メール送信
    OrderService-->>OrderController: OrderResponse
    OrderController-->>FE: JSON (OrderResponse)
    FE-->>User: 購入確定画面を表示
</div>

### 4.5.2. ログイン・ログアウトシーケンス図 (セッション管理)

<div class="mermaid">
sequenceDiagram
    %% No.1: 購入フロー一式
    participant User as ユーザー (Browser)
    participant FE as フロントエンド (JS)
    participant CartController
    participant CartService
    participant ProductRepository
    participant OrderController
    participant OrderService
    participant OrderRepository
    participant OrderDetailRepository
    participant MailService
    participant DB as データベース

    User->>FE: 商品をカートに追加
    FE->>CartController: POST /api/cart/add
    CartController->>CartService: addItem(productId, qty, session)
    CartService->>ProductRepository: findById(productId)
    ProductRepository->>DB: SELECT * FROM products WHERE id=?
    DB-->>ProductRepository: Product
    ProductRepository-->>CartService: Product
    CartService-->>CartController: Updated Cart
    CartController-->>FE: JSON (Updated Cart)
    FE-->>User: カートを表示

    User->>FE: 購入手続き
    FE->>OrderController: POST /api/orders
    OrderController->>OrderService: placeOrder(cart, orderRequest)
    OrderService->>OrderRepository: save(Order)
    OrderRepository->>DB: INSERT INTO orders ...
    DB-->>OrderRepository: Order ID
    OrderService->>OrderDetailRepository: saveAll(OrderDetails)
    OrderDetailRepository->>DB: INSERT INTO order_details ...
    DB-->>OrderDetailRepository: Success
    OrderService->>MailService: sendOrderConfirmationEmail()
    MailService->>User: 確認メール送信
    OrderService-->>OrderController: OrderResponse
    OrderController-->>FE: JSON (OrderResponse)
    FE-->>User: 購入確定画面を表示


    %% No.2: 会員登録、ログイン・ログアウト機能
    participant User as ユーザー (Browser)
    participant FE as フロントエンド (JS)
    participant CustomerController
    participant CustomerService
    participant CustomerRepository
    participant Session as セッション管理
    participant DB as データベース

    User->>FE: 会員登録フォーム入力
    FE->>CustomerController: POST /api/customers/register
    CustomerController->>CustomerService: registerCustomer(request)
    CustomerService->>CustomerRepository: save(Customer)
    CustomerRepository->>DB: INSERT INTO customers ...
    DB-->>CustomerRepository: 保存成功
    CustomerService-->>CustomerController: CustomerResponse
    CustomerController-->>FE: JSON (CustomerResponse)
    FE-->>User: 会員登録完了画面を表示

    User->>FE: ログイン情報入力
    FE->>CustomerController: POST /api/customers/login
    CustomerController->>CustomerService: authenticate(request)
    CustomerService->>CustomerRepository: findByEmail()
    CustomerRepository->>DB: SELECT * FROM customers WHERE email=?
    DB-->>CustomerRepository: Customer
    CustomerRepository-->>CustomerService: Customer
    CustomerService->>Session: セッションへ会員情報保存
    CustomerService-->>CustomerController: CustomerResponse
    CustomerController-->>FE: JSON (CustomerResponse)
    FE-->>User: マイページ表示

    User->>FE: ログアウト操作
    FE->>CustomerController: POST /api/customers/logout
    CustomerController->>Session: セッション破棄
    Session-->>CustomerController: OK
    CustomerController-->>FE: OK
    FE-->>User: ログイン画面を表示
</div>

### 4.5.3. マイページ・注文履歴・会員情報変更シーケンス図 

<div class="mermaid">
sequenceDiagram
    %% No.1: 購入フロー一式
    participant User as ユーザー (Browser)
    participant FE as フロントエンド (JS)
    participant CartController
    participant CartService
    participant ProductRepository
    participant OrderController
    participant OrderService
    participant OrderRepository
    participant OrderDetailRepository
    participant MailService
    participant DB as データベース

    User->>FE: 商品をカートに追加
    FE->>CartController: POST /api/cart/add
    CartController->>CartService: addItem(productId, qty, session)
    CartService->>ProductRepository: findById(productId)
    ProductRepository->>DB: SELECT * FROM products WHERE id=?
    DB-->>ProductRepository: Product
    ProductRepository-->>CartService: Product
    CartService-->>CartController: Updated Cart
    CartController-->>FE: JSON (Updated Cart)
    FE-->>User: カートを表示

    User->>FE: 購入手続き
    FE->>OrderController: POST /api/orders
    OrderController->>OrderService: placeOrder(cart, orderRequest)
    OrderService->>OrderRepository: save(Order)
    OrderRepository->>DB: INSERT INTO orders ...
    DB-->>OrderRepository: Order ID
    OrderService->>OrderDetailRepository: saveAll(OrderDetails)
    OrderDetailRepository->>DB: INSERT INTO order_details ...
    DB-->>OrderDetailRepository: Success
    OrderService->>MailService: sendOrderConfirmationEmail()
    MailService->>User: 確認メール送信
    OrderService-->>OrderController: OrderResponse
    OrderController-->>FE: JSON (OrderResponse)
    FE-->>User: 購入確定画面を表示


    %% No.2: 会員登録、ログイン・ログアウト機能
    participant User as ユーザー (Browser)
    participant FE as フロントエンド (JS)
    participant CustomerController
    participant CustomerService
    participant CustomerRepository
    participant Session as セッション管理
    participant DB as データベース

    User->>FE: 会員登録フォーム入力
    FE->>CustomerController: POST /api/customers/register
    CustomerController->>CustomerService: registerCustomer(request)
    CustomerService->>CustomerRepository: save(Customer)
    CustomerRepository->>DB: INSERT INTO customers ...
    DB-->>CustomerRepository: 保存成功
    CustomerService-->>CustomerController: CustomerResponse
    CustomerController-->>FE: JSON (CustomerResponse)
    FE-->>User: 会員登録完了画面を表示

    User->>FE: ログイン情報入力
    FE->>CustomerController: POST /api/customers/login
    CustomerController->>CustomerService: authenticate(request)
    CustomerService->>CustomerRepository: findByEmail()
    CustomerRepository->>DB: SELECT * FROM customers WHERE email=?
    DB-->>CustomerRepository: Customer
    CustomerRepository-->>CustomerService: Customer
    CustomerService->>Session: セッションへ会員情報保存
    CustomerService-->>CustomerController: CustomerResponse
    CustomerController-->>FE: JSON (CustomerResponse)
    FE-->>User: マイページ表示

    User->>FE: ログアウト操作
    FE->>CustomerController: POST /api/customers/logout
    CustomerController->>Session: セッション破棄
    Session-->>CustomerController: OK
    CustomerController-->>FE: OK
    FE-->>User: ログイン画面を表示


    %% No.3: マイページ・注文履歴・会員情報変更
    participant User as ユーザー (Browser)
    participant FE as フロントエンド (JS)
    participant CustomerController
    participant CustomerService
    participant OrderRepository
    participant CustomerRepository
    participant Session as セッション管理
    participant DB as データベース

    User->>FE: マイページアクセス
    FE->>CustomerController: GET /api/customers/mypage
    CustomerController->>Session: 顧客IDを取得
    Session-->>CustomerController: customerId
    CustomerController->>CustomerService: getCustomerProfile(customerId)
    CustomerService->>CustomerRepository: findById(customerId)
    CustomerRepository->>DB: SELECT * FROM customers WHERE id=?
    DB-->>CustomerRepository: Customer
    CustomerRepository-->>CustomerService: Customer
    CustomerService-->>CustomerController: CustomerResponse
    CustomerController-->>FE: JSON (CustomerResponse)
    FE-->>User: プロフィール表示

    User->>FE: 注文履歴の表示
    FE->>CustomerController: GET /api/customers/orders
    CustomerController->>Session: 顧客IDを取得
    Session-->>CustomerController: customerId
    CustomerController->>CustomerService: getOrderHistory(customerId)
    CustomerService->>OrderRepository: findByCustomerId(customerId)
    OrderRepository->>DB: SELECT * FROM orders WHERE customer_id=?
    DB-->>OrderRepository: List<Order>
    OrderRepository-->>CustomerService: List<Order>
    CustomerService-->>CustomerController: List<OrderSummary>
    CustomerController-->>FE: JSON (OrderSummary List)
    FE-->>User: 注文履歴を表示

    User->>FE: 会員情報の変更を入力
    FE->>CustomerController: PUT /api/customers/update
    CustomerController->>Session: 顧客IDを取得
    Session-->>CustomerController: customerId
    CustomerController->>CustomerService: updateCustomerInfo(request)
    CustomerService->>CustomerRepository: save(updatedCustomer)
    CustomerRepository->>DB: UPDATE customers SET ...
    DB-->>CustomerRepository: 更新成功
    CustomerRepository-->>CustomerService: 更新後Customer
    CustomerService-->>CustomerController: CustomerResponse
    CustomerController-->>FE: JSON (CustomerResponse)
    FE-->>User: 更新完了メッセージ表示
</div>


### 4.5.4.  カート操作・購入前ログインシーケンス図

<div class="mermaid">
sequenceDiagram
    %% No.4: カート操作・購入前ログイン
    participant User as ユーザー (Browser)
    participant FE as フロントエンド (JS)
    participant CartController
    participant CartService
    participant ProductRepository
    participant Session as セッション管理
    participant DB as データベース
    participant CustomerController
    participant CustomerService
    participant CustomerRepository

    User->>FE: 商品をカートに追加
    FE->>CartController: POST /api/cart/add
    CartController->>CartService: addItemToCart(productId, quantity, session)
    CartService->>ProductRepository: findById(productId)
    ProductRepository->>DB: SELECT * FROM products WHERE id=?
    DB-->>ProductRepository: Product
    ProductRepository-->>CartService: Product
    CartService-->>CartController: Updated Cart
    CartController-->>FE: JSON (Cart)
    FE-->>User: カートを表示

    User->>FE: ログイン操作
    FE->>CustomerController: POST /api/customers/login
    CustomerController->>CustomerService: authenticate(request)
    CustomerService->>CustomerRepository: findByEmail()
    CustomerRepository->>DB: SELECT * FROM customers WHERE email=?
    DB-->>CustomerRepository: Customer
    CustomerRepository-->>CustomerService: Customer
    CustomerService->>Session: セッションへ会員情報保存
    CustomerService-->>CustomerController: CustomerResponse
    CustomerController-->>FE: JSON (CustomerResponse)
    FE-->>User: ログイン完了後にカート画面を再表示
</div>

### 商品一覧4.5.5.  カート操作・購入前ログインシーケンス図 

<div class="mermaid">
%% No.5: 商品一覧・詳細表示
sequenceDiagram
    participant User as ユーザー (Browser)
    participant FE as フロントエンド (JS)
    participant ProductController
    participant ProductService
    participant ProductRepository
    participant DB as データベース

    User->>FE: 商品一覧ページへアクセス
    FE->>ProductController: GET /api/products
    ProductController->>ProductService: getAllProducts()
    ProductService->>ProductRepository: findAll()
    ProductRepository->>DB: SELECT * FROM products
    DB-->>ProductRepository: 商品データリスト
    ProductRepository-->>ProductService: List<Product>
    ProductService->>ProductService: ProductエンティティからProductListItem DTOへ変換
    ProductService-->>ProductController: List<ProductListItem>
    ProductController-->>FE: 商品リスト (JSON)
    FE-->>User: 商品一覧画面を表示

    User->>FE: 商品詳細をクリック
    FE->>ProductController: GET /api/products/{id}
    ProductController->>ProductService: getProductById(id)
    ProductService->>ProductRepository: findById(id)
    ProductRepository->>DB: SELECT * FROM products WHERE id=?
    DB-->>ProductRepository: Product
    ProductRepository-->>ProductService: Product
    ProductService->>ProductService: ProductエンティティからProductDetail DTOへ変換
    ProductService-->>ProductController: ProductDetail
    ProductController-->>FE: JSON (ProductDetail)
    FE-->>User: 商品詳細画面を表示
</div>

### 商品一覧4.5.6. 自動入力シーケンス図

<div class="mermaid">
 sequenceDiagram
    participant User as ユーザー (Browser)
    participant FE as フロントエンド (JS)
    participant Session as セッション管理

    User->>FE: 注文フォームを開く
    FE->>Session: 顧客情報の取得 (ログイン中)
    Session-->>FE: Customer情報 (name, address, phone)
    FE-->>User: 注文フォームに自動入力表示
</div>

### 商品一覧4.5.7. 注文確定通知シーケンス図


<div class="mermaid">
sequenceDiagram
    participant OrderService
    participant MailService
    participant User as ユーザー (メール受信者)

    OrderService->>MailService: sendOrderConfirmationEmail(order)
    MailService->>User: 注文確定メール送信 (order summary)
    MailService-->>OrderService: メール送信完了
</div>
